"use strict";(self.webpackChunktcadmin_docs=self.webpackChunktcadmin_docs||[]).push([[8413],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>y});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},s=Object.keys(e);for(r=0;r<s.length;r++)a=s[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)a=s[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=r.createContext({}),p=function(e){var t=r.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},m=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,s=e.originalType,l=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),c=p(a),d=n,y=c["".concat(l,".").concat(d)]||c[d]||u[d]||s;return a?r.createElement(y,i(i({ref:t},m),{},{components:a})):r.createElement(y,i({ref:t},m))}));function y(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var s=a.length,i=new Array(s);i[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[c]="string"==typeof e?e:n,i[1]=o;for(var p=2;p<s;p++)i[p]=a[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}d.displayName="MDXCreateElement"},2612:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>p});var r=a(7462),n=(a(7294),a(3905));const s={sidebar_position:3,sidebar_label:"Automatically Create a MySQL Database"},i="Automatically Create a MySQL Database",o={unversionedId:"customizations/scripts/general-scripts/automatically-create-mysql-database",id:"customizations/scripts/general-scripts/automatically-create-mysql-database",title:"Automatically Create a MySQL Database",description:"Rather than utilizing these legacy scripts, we advise installing the MySQL Manager module for optimal results.",source:"@site/docs/customizations/scripts/general-scripts/automatically-create-mysql-database.mdx",sourceDirName:"customizations/scripts/general-scripts",slug:"/customizations/scripts/general-scripts/automatically-create-mysql-database",permalink:"/customizations/scripts/general-scripts/automatically-create-mysql-database",draft:!1,editUrl:"https://github.com/TotalControlAdmin/tcadmin-docs/blob/master/docs/customizations/scripts/general-scripts/automatically-create-mysql-database.mdx",tags:[],version:"current",lastUpdatedAt:1693210718,formattedLastUpdatedAt:"Aug 28, 2023",sidebarPosition:3,frontMatter:{sidebar_position:3,sidebar_label:"Automatically Create a MySQL Database"},sidebar:"tutorialSidebar",previous:{title:"Allow User to Change Slots",permalink:"/customizations/scripts/general-scripts/allow-user-to-change-slots"},next:{title:"Backup & Restore Scripts",permalink:"/customizations/scripts/general-scripts/backup-restore-scripts"}},l={},p=[{value:"Preparing the server",id:"preparing-the-server",level:2},{value:"Configure the game",id:"configure-the-game",level:2},{value:"Create variables",id:"create-variables",level:3},{value:"Create the scripts",id:"create-the-scripts",level:3},{value:"Create the custom link to phpMyadmin",id:"create-the-custom-link-to-phpmyadmin",level:3},{value:"Using the MySQL variables in templates",id:"using-the-mysql-variables-in-templates",level:3},{value:"Optional scripts",id:"optional-scripts",level:3},{value:"Icon to Change MySQL Password",id:"icon-to-change-mysql-password",level:4},{value:"Backup the database when the service is moved and restore it on the new server",id:"backup-the-database-when-the-service-is-moved-and-restore-it-on-the-new-server",level:3}],m={toc:p},c="wrapper";function u(e){let{components:t,...a}=e;return(0,n.kt)(c,(0,r.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"automatically-create-a-mysql-database"},"Automatically Create a MySQL Database"),(0,n.kt)("admonition",{title:"Use MySQL Manager",type:"caution"},(0,n.kt)("p",{parentName:"admonition"},"Rather than utilizing these legacy scripts, we advise installing the MySQL Manager module for optimal results.")),(0,n.kt)("h2",{id:"preparing-the-server"},"Preparing the server"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Install the MySQL server on your server."),(0,n.kt)("li",{parentName:"ul"},"Install phpMyAdmin if you want to provide a way to manage the database.")),(0,n.kt)("h2",{id:"configure-the-game"},"Configure the game"),(0,n.kt)("h3",{id:"create-variables"},"Create variables"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Configure variables for the MySQL user and password. Go to ",(0,n.kt)("inlineCode",{parentName:"li"},"Settings")," > ",(0,n.kt)("inlineCode",{parentName:"li"},"Global Variables")," or ",(0,n.kt)("inlineCode",{parentName:"li"},"Settings")," > ",(0,n.kt)("inlineCode",{parentName:"li"},"Games")," > ",(0,n.kt)("inlineCode",{parentName:"li"},"Select the game")," > ",(0,n.kt)("inlineCode",{parentName:"li"},"Variables"),". Create 2 new variables",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Name: ",(0,n.kt)("inlineCode",{parentName:"li"},"MySQLUser")),(0,n.kt)("li",{parentName:"ul"},"Preserve value: ",(0,n.kt)("inlineCode",{parentName:"li"},"Checked")),(0,n.kt)("li",{parentName:"ul"},"Name: ",(0,n.kt)("inlineCode",{parentName:"li"},"MySQLPassword")),(0,n.kt)("li",{parentName:"ul"},"Preserve value: ",(0,n.kt)("inlineCode",{parentName:"li"},"Checked"))))),(0,n.kt)("h3",{id:"create-the-scripts"},"Create the scripts"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Go to ",(0,n.kt)("inlineCode",{parentName:"li"},"Settings")," > ",(0,n.kt)("inlineCode",{parentName:"li"},"Global Scripts")," or ",(0,n.kt)("inlineCode",{parentName:"li"},"Settings")," > ",(0,n.kt)("inlineCode",{parentName:"li"},"Games")," > ",(0,n.kt)("inlineCode",{parentName:"li"},"Select the game")," > ",(0,n.kt)("inlineCode",{parentName:"li"},"Custom Scripts"),". Add the following scripts. They will create the database and user when the service is created and delete them when the service is deleted. Make sure you update the value of mysql_password in all of the scripts."),(0,n.kt)("li",{parentName:"ul"},"If you are using MySQL 8 remove the MySQL 5 command and uncomment the MySQL 8 commands."),(0,n.kt)("li",{parentName:"ul"},"These scripts work without any additional changes if MySQL is installed on all servers (master and remotes). If you have a single MySQL server where all remotes connect you will have to change user@localhost to user@% in the user commands and configure your root user to allow connections from all IPs.")),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Operating System:")," Any",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Description:")," Generate MySQL user and password",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Script Engine:")," IronPython",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Event:")," Before created",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Ignore execution errors:")," Unchecked",(0,n.kt)("br",{parentName:"p"}),"\n","Script:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'import clr;\nimport System;\n\nclr.AddReference("TCAdmin.SDK");\nfrom TCAdmin.SDK.Misc import Random;\nfrom System import String;\n\nThisService.Variables["MySQLUser"] = String.Format("db{0}", ThisService.ServiceId);\nThisService.Variables["MySQLPassword"] = Random.RandomString(10,True,True);\nThisService.Save();\n')),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Operating System:")," Any",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Description:")," Create MySQL database and user",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Script Engine:")," IronPython",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Event:")," After created",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Ignore execution errors:")," Unchecked",(0,n.kt)("br",{parentName:"p"}),"\n","Script:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'import clr;\nimport System;\n\nclr.AddReference("TCAdmin.DatabaseProviders.MySql");\nclr.AddReference("TCAdmin.SDK");\nfrom TCAdmin.DatabaseProviders.MySql import MySqlManager;\nfrom System import String;\n\nmysql_server="localhost";\nmysql_root="root";\nmysql_password="";\n\nwith MySqlManager() as mysql:\n escapeduser=mysql.PrepareSqlValue(ThisService.Variables["MySQLUser"]);\n escapedpass=mysql.PrepareSqlValue(ThisService.Variables["MySQLPassword"]);\n mysql.DisableReplication=True;\n mysql.Connect(String.Format("Data Source={0};User Id={1};Password={2};Pooling=False;", mysql_server, mysql_root, mysql_password));\n\n mysql.ExecuteNonQuery(String.Format("DROP DATABASE IF EXISTS {0};", escapeduser));\n if mysql.Execute(String.Format("SELECT * FROM mysql.user WHERE user=\'{0}\' AND host=\'localhost\';", escapeduser)).Rows.Count == 1 :\n  mysql.ExecuteNonQuery(String.Format("DROP USER {0}@\'localhost\';", escapeduser));\n\n mysql.ExecuteNonQuery(String.Format("CREATE DATABASE {0};", escapeduser));\n ## MYSQL 5 SYNTAX\n mysql.ExecuteNonQuery(String.Format("GRANT ALL PRIVILEGES ON {0}.* TO \'{0}\'@\'localhost\' IDENTIFIED BY \'{1}\';", escapeduser, escapedpass));\n ## MYSQL 8 SYNTAX\n #mysql.ExecuteNonQuery(String.Format("CREATE USER \'{0}\'@\'localhost\' IDENTIFIED BY \'{1}\';", escapeduser, escapedpass));\n #mysql.ExecuteNonQuery(String.Format("GRANT ALL PRIVILEGES ON {0}.* TO \'{0}\'@\'localhost\';", escapeduser));\n\n#Add these lines  to the "Create MySQL database and user" script if you want to execute a .sql file \nwith MySqlManager() as mysql2:\n mysql2.DisableReplication=True;\n mysql2.Connect(String.Format("Data Source={0};Database={1};User Id= {1};Password={2};Pooling=False;", mysql_server, ThisService.Variables["MySQLUser"], ThisService.Variables["MySQLPassword"]));\n mysql2.ImportDatabase(ThisService.RootDirectory + "db.sql");\n')),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Operating System:")," Any",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Description:")," Delete MySQL database and user",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Script Engine:")," IronPython",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Event:")," Before deleted",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Ignore execution errors:")," Unchecked",(0,n.kt)("br",{parentName:"p"}),"\n","Script:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'import clr;\nimport System;\n\nclr.AddReference("TCAdmin.DatabaseProviders.MySql");\nclr.AddReference("TCAdmin.SDK");\nfrom TCAdmin.DatabaseProviders.MySql import MySqlManager;\nfrom System import String;\n\nmysql_server="localhost";\nmysql_root="root";\nmysql_password="";\n\nif not ThisService.Variables.HasValue("MySQLUser") :\n Script.Exit();\n\nif ThisService.Variables["MySQLUser"] == String.Empty:\n Script.Exit();\n\nwith MySqlManager() as mysql:\n escapeduser=mysql.PrepareSqlValue(ThisService.Variables["MySQLUser"]);\n mysql.DisableReplication=True;\n mysql.Connect(String.Format("Data Source={0};User Id={1};Password={2};Pooling=False;", mysql_server, mysql_root, mysql_password));\n\n mysql.ExecuteNonQuery(String.Format("DROP DATABASE IF EXISTS {0};", escapeduser));\n if mysql.Execute(String.Format("SELECT * FROM mysql.user WHERE user=\'{0}\' AND host=\'localhost\';", escapeduser)).Rows.Count == 1 :\n  mysql.ExecuteNonQuery(String.Format("DROP USER {0}@\'localhost\';", escapeduser));\n')),(0,n.kt)("h3",{id:"create-the-custom-link-to-phpmyadmin"},"Create the custom link to phpMyadmin"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"If you installed phpMyAdmin you can create a custom link. Go back to the game's main settings. Click on the Custom Links icon. Add a new link with these values:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Name: ",(0,n.kt)("inlineCode",{parentName:"li"},"phpMyAdmin")),(0,n.kt)("li",{parentName:"ul"},"Description: ",(0,n.kt)("inlineCode",{parentName:"li"},"Manage your database with phpMyAdmin")),(0,n.kt)("li",{parentName:"ul"},"Url:",(0,n.kt)("inlineCode",{parentName:"li"}," http://$[Service.IpHostname]/phpMyAdmin/index.php?pma_username=![MySQLUser]&pma_password=![MySQLPassword] (you can also use https://phpmyadmin.tcadmin.com)")),(0,n.kt)("li",{parentName:"ul"},"Icon URL: ",(0,n.kt)("inlineCode",{parentName:"li"},"~/App_Themes/Default/Images/ControlPanel/MenuIcons/Base/Database.png")),(0,n.kt)("li",{parentName:"ul"},"Open in a new window: ",(0,n.kt)("inlineCode",{parentName:"li"},"Checked"))))),(0,n.kt)("admonition",{title:"update",type:"note"},(0,n.kt)("p",{parentName:"admonition"},"Newer phpMyAdmin versions don't allow logging in to mysql with the username/password in the url. ",(0,n.kt)("a",{parentName:"p",href:"https://www.phpmyadmin.net/files/4.9.0.1/"},"https://www.phpmyadmin.net/files/4.9.0.1/"))),(0,n.kt)("h3",{id:"using-the-mysql-variables-in-templates"},"Using the MySQL variables in templates"),(0,n.kt)("p",null,"You can use the following variables in your mail and config file templates:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},(0,n.kt)("inlineCode",{parentName:"strong"},"![MySQLUser]"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},(0,n.kt)("inlineCode",{parentName:"strong"},"[MySQLPassword]")))),(0,n.kt)("h3",{id:"optional-scripts"},"Optional scripts"),(0,n.kt)("h4",{id:"icon-to-change-mysql-password"},"Icon to Change MySQL Password"),(0,n.kt)("p",null,"Create a variable named NewMySQLPassword. with:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},'These options checked: "Script parameter", "Save script parameter value", "Admin access", "Sub admin access", "Reseller access", "User access", "Server owner access", "Value is required"'),(0,n.kt)("li",{parentName:"ul"},"Label=New Password"),(0,n.kt)("li",{parentName:"ul"},"Mode=Password"),(0,n.kt)("li",{parentName:"ul"},"Deny Characters=;&\"'\\/")),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Operating System:")," Any",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Description:")," Change MySQL Password",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Script Engine:")," IronPython",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Event:")," Custom Icon",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Ignore execution errors:")," Unchecked",(0,n.kt)("br",{parentName:"p"}),"\n","Script:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'import clr;\nimport System;\nclr.AddReference("TCAdmin.DatabaseProviders.MySql");\nclr.AddReference("TCAdmin.SDK");\nfrom TCAdmin.DatabaseProviders.MySql import MySqlManager;\nfrom System import String;\n\nmysql_server="localhost";\nmysql_root="root";\nmysql_password="";\n\nwith MySqlManager() as mysql:\n escapeduser=mysql.PrepareSqlValue(ThisService.Variables["MySQLUser"]);\n escapedpass=mysql.PrepareSqlValue(ThisService.Variables["MySQLPassword"]);\n escapednewpass=mysql.PrepareSqlValue(ThisService.Variables["NewMySQLPassword"]);\n mysql.DisableReplication=True;\n mysql.Connect(String.Format("Data Source={0};User Id={1};Password={2};Pooling=False;", mysql_server, mysql_root, mysql_password));\n mysql.ExecuteNonQuery(String.Format("SET PASSWORD FOR \'{0}\'@\'localhost\' = PASSWORD(\'{1}\');", escapeduser, escapednewpass));\n mysql.ExecuteNonQuery("FLUSH PRIVILEGES;");\n ThisService.Variables["MySQLPassword"] = ThisService.Variables["NewMySQLPassword"]\n ThisService.Variables["NewMySQLPassword"] = String.Empty\n ThisService.Save()\n  \nScript.WriteToConsole("Your password has been updated successfully.")\nScript.WriteToConsole("")\n')),(0,n.kt)("h3",{id:"backup-the-database-when-the-service-is-moved-and-restore-it-on-the-new-server"},"Backup the database when the service is moved and restore it on the new server"),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Operating System:")," Any",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Description:")," Backup MySQL database before moving",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Script Engine:")," IronPython",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Event:")," Before move",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Ignore execution errors:")," Unchecked",(0,n.kt)("br",{parentName:"p"}),"\n","Script:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'import clr;\nimport System;\n\nclr.AddReference("TCAdmin.DatabaseProviders.MySql");\nclr.AddReference("TCAdmin.SDK");\nfrom TCAdmin.DatabaseProviders.MySql import MySqlManager;\nfrom System import String;\nfrom System.IO import FileStream, Path, FileMode, FileAccess;\n\nmysql_server="localhost";\nmysql_root="root";\nmysql_password="";\n\nif not ThisService.Variables.HasValue("MySQLUser") :\n Script.Exit();\n \nif ThisService.Variables["MySQLUser"] == "" :\n Script.Exit();\n\nbackupfile=Path.Combine(ThisService.RootDirectory, "_backup.sql");\n\nwith MySqlManager() as mysql:\n escapeduser=mysql.PrepareSqlValue(ThisService.Variables["MySQLUser"]);\n escapedpass=mysql.PrepareSqlValue(ThisService.Variables["MySQLPassword"]);\n mysql.AutoDisconnect = False;\n mysql.DisableReplication=True;\n mysql.Connect(String.Format("Data Source={0};User Id={1};Password={2};Pooling=False;", mysql_server, mysql_root, mysql_password));\n #only make a backup if database exists and has tables\n if mysql.Execute(String.Format("SHOW DATABASES LIKE \'{0}\';", escapeduser)).Rows.Count == 1 :\n  mysql.ExecuteNonQuery(String.Format("USE {0};", escapeduser));\n  if mysql.Execute("SHOW TABLES;").Rows.Count > 0 :\n   with FileStream(backupfile, FileMode.Create, FileAccess.Write) as file:\n    mysql.DumpDatabase(file);\n\n mysql.ExecuteNonQuery(String.Format("DROP DATABASE IF EXISTS {0};", escapeduser));\n if mysql.Execute(String.Format("SELECT * FROM mysql.user WHERE user=\'{0}\' AND host=\'localhost\';", escapeduser)).Rows.Count == 1 :\n  mysql.ExecuteNonQuery(String.Format("DROP USER \'{0}\'@\'localhost\';", escapeduser));\n')),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Operating System:")," Any",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Description:")," Restore MySQL database after move",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Script Engine:")," IronPython",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Event:")," After move",(0,n.kt)("br",{parentName:"p"}),"\n",(0,n.kt)("strong",{parentName:"p"},"Ignore execution errors:")," Unchecked",(0,n.kt)("br",{parentName:"p"}),"\n","Script:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'import clr;\nimport System;\n\nclr.AddReference("TCAdmin.DatabaseProviders.MySql");\nclr.AddReference("TCAdmin.SDK");\nfrom TCAdmin.DatabaseProviders.MySql import MySqlManager;\nfrom System import String;\nfrom System.IO import File, Path;\n\nmysql_server="localhost";\nmysql_root="root";\nmysql_password="";\n\nif not ThisService.Variables.HasValue("MySQLUser") :\n Script.Exit();\n\nif ThisService.Variables["MySQLUser"] == "" :\n Script.Exit();\n\nbackupfile=Path.Combine(ThisService.RootDirectory, "_backup.sql");\n\nwith MySqlManager() as mysql:\n escapeduser=mysql.PrepareSqlValue(ThisService.Variables["MySQLUser"]);\n escapedpass=mysql.PrepareSqlValue(ThisService.Variables["MySQLPassword"]);\n mysql.DisableReplication=True;\n mysql.Connect(String.Format("Data Source={0};User Id={1};Password={2};Pooling=False;", mysql_server, mysql_root, mysql_password));\n \n mysql.ExecuteNonQuery(String.Format("DROP DATABASE IF EXISTS {0};", escapeduser));\n if mysql.Execute(String.Format("SELECT * FROM mysql.user WHERE user=\'{0}\' AND host=\'localhost\';", escapeduser)).Rows.Count == 1 :\n  mysql.ExecuteNonQuery(String.Format("DROP USER \'{0}\'@\'localhost\';", escapeduser));\n\n ## MYSQL 5 SYNTAX\n mysql.ExecuteNonQuery(String.Format("CREATE DATABASE {0};", escapeduser));\n mysql.ExecuteNonQuery(String.Format("GRANT ALL PRIVILEGES ON {0}.* TO \'{0}\'@\'localhost\' IDENTIFIED BY \'{1}\';", escapeduser, escapedpass));\n ## MYSQL 8 SYNTAX\n #mysql.ExecuteNonQuery(String.Format("CREATE USER \'{0}\'@\'localhost\' IDENTIFIED BY \'{1}\';", escapeduser, escapedpass));\n #mysql.ExecuteNonQuery(String.Format("GRANT ALL PRIVILEGES ON {0}.* TO \'{0}\'@\'localhost\';", escapeduser)); \n\nif File.Exists(backupfile) :\n with MySqlManager() as mysql2:\n  mysql2.DisableReplication=True;\n  mysql2.Connect(String.Format("Data Source={0};Database={1};User Id={1};Password={2};Pooling=False;", mysql_server, ThisService.Variables["MySQLUser"], ThisService.Variables["MySQLPassword"]));\n  mysql2.ImportDatabase(backupfile);\n  File.Delete(backupfile);\n')))}u.isMDXComponent=!0}}]);