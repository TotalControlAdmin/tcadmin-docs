"use strict";(globalThis.webpackChunktcadmin_docs=globalThis.webpackChunktcadmin_docs||[]).push([[5808],{72758(e,r,n){n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"customizations/scripts/general-scripts/backup-restore-scripts","title":"Backup & Restore Scripts","description":"Secure your Backups folder","source":"@site/versioned_docs/version-2/customizations/scripts/general-scripts/backup-restore-scripts.mdx","sourceDirName":"customizations/scripts/general-scripts","slug":"/customizations/scripts/general-scripts/backup-restore-scripts","permalink":"/customizations/scripts/general-scripts/backup-restore-scripts","draft":false,"unlisted":false,"editUrl":"https://github.com/TotalControlAdmin/tcadmin-docs/blob/master/versioned_docs/version-2/customizations/scripts/general-scripts/backup-restore-scripts.mdx","tags":[],"version":"2","lastUpdatedAt":1771865146000,"sidebarPosition":4,"frontMatter":{"sidebar_position":4,"sidebar_label":"Backup & Restore Scripts"},"sidebar":"tutorialSidebar","previous":{"title":"Automatically Create a MySQL Database","permalink":"/customizations/scripts/general-scripts/automatically-create-mysql-database"},"next":{"title":"Backup & Restore Scripts with FTP Support","permalink":"/customizations/scripts/general-scripts/backup-restore-scripts-with-ftp-support"}}');var i=n(74848),t=n(28453);const o={sidebar_position:4,sidebar_label:"Backup & Restore Scripts"},c="Backup & Restore Scripts",l={},a=[{value:"Secure your Backups folder",id:"secure-your-backups-folder",level:2},{value:"Create the variable",id:"create-the-variable",level:2},{value:"Create the scripts",id:"create-the-scripts",level:2}];function d(e){const r={admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"backup--restore-scripts",children:"Backup & Restore Scripts"})}),"\n",(0,i.jsx)(r.h2,{id:"secure-your-backups-folder",children:"Secure your Backups folder"}),"\n",(0,i.jsx)(r.admonition,{title:"Urgent Warning: Critical Configuration Step - Neglect at Your Peril!",type:"danger",children:(0,i.jsx)(r.p,{children:"Failure to execute this pivotal step in the configuration process will render your server alarmingly susceptible to exploitations and security breaches."})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Go to ",(0,i.jsx)(r.code,{children:"Settings"})," > ",(0,i.jsx)(r.code,{children:"Games"})," > ",(0,i.jsx)(r.code,{children:"Select the game"})," > ",(0,i.jsx)(r.code,{children:"File System Permissions"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Expand User Files and select ",(0,i.jsx)(r.strong,{children:"Add permissions by subdirectory"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Configure these values:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Subdirectory Path: Backups"}),"\n",(0,i.jsxs)(r.li,{children:["Permissions:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["If you don't want to allow manual download of the backup files set it to ",(0,i.jsx)(r.code,{children:"no permissions"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["If you want to allow the user to download and delete backups set it to ",(0,i.jsx)(r.code,{children:"Basic permissions"})," and check ",(0,i.jsx)(r.code,{children:"Read"})," and ",(0,i.jsx)(r.code,{children:"Delete"}),". ",(0,i.jsx)(r.strong,{children:'DO NOT check "write".'})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.li,{children:"Click on Add."}),"\n",(0,i.jsxs)(r.li,{children:["Add the same permission for ",(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"Sub Admin Files"})})," and ",(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"Reseller Files"})}),"."]}),"\n",(0,i.jsx)(r.li,{children:"Click on Save."}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"create-the-variable",children:"Create the variable"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Configure a variable used by the restore script"}),". Go to ",(0,i.jsx)(r.code,{children:"Settings"})," > ",(0,i.jsx)(r.code,{children:"Games"})," > ",(0,i.jsx)(r.code,{children:"Select the game"})," > ",(0,i.jsx)(r.code,{children:"Variables"})," (it can also be a global variable). Create this variable:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Name:"})," BackupFile"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Script parameter:"})," Checked"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Admin access:"})," Checked"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Sub admin access:"})," Checked"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Reseller access:"})," Checked"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"User access:"})," Checked"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Server owner access:"})," Checked"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Value is required:"})," Checked"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Required Message:"})," The backup file is required."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Item Type:"})," Combobox"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Label:"})," Backup:"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Description:"})," Select the backup to restore."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Source:"})," File System"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Filter Type:"})," Files"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Filter:"})," Backups/*.zip"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Item Value:"})," Full path"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Item Display:"})," Name (no extension)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"create-the-scripts",children:"Create the scripts"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Go back to the game's main settings. Click on the Custom Scripts icon. Add the following scripts. They can also be configured as global scripts."}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Operating System:"})," Any",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Name:"})," Backup Your Settings",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Description:"})," Create a backup of your game server's settings.",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Script Engine:"})," IronPython",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Event:"})," Custom Icon",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Sub admin access:"})," Checked",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Reseller access:"})," Checked",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"User access:"})," Checked",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Server owner access:"})," Checked",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Stop service before executing:"})," Check if you want to stop the game server before creating the backup.",(0,i.jsx)(r.br,{}),"\n","Script: Configure BACKUP_LOCATION, MAX_BACKUPS, BACKUP_EXTENSIONS, FOLDER_TO_BACKUP as needed."]}),"\n",(0,i.jsx)(r.admonition,{type:"tip",children:(0,i.jsx)(r.p,{children:"If you change the backup location remember to update your file system permissions."})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'import clr;\nclr.AddReference("TCAdmin.SDK");\n\nimport System;\nfrom System import Array, String, DateTime, Exception, Environment, PlatformID\nfrom System.IO import Path, DirectoryInfo, SearchOption\nfrom System.Collections.Generic import List\nfrom System.Globalization import CultureInfo\nfrom TCAdmin.SDK.Misc import CompressionTools, Linux, Windows\n\nclr.AddReference("System.Core")\nclr.ImportExtensions(System.Linq)\n\n# Specify where backups are saved.\n# Default location is a folder named Backups in the game server\'s root.\nBACKUP_LOCATION = Path.Combine(ThisService.RootDirectory, "Backups")\n\n# Specify the maximum number of backups to keep.\nMAX_BACKUPS = 5\n\n# Extension of files that will be included in the backup.\n# Only specify config file extensions to keep file size small. Avoid log extensions.\n# For security do not backup executables (.exe, .dll or .so, etc). Use ".*" to backup all extensions in the specified folder.\nBACKUP_EXTENSIONS = Array[str]([".cfg", ".lua", ".properties", ".txt"])\n\n# Extensions that are excluded from the backup. (only used if you specify ".*" in BACKUP_EXTENSIONS)\nBACKUP_EXCLUDE_EXTENSIONS = Array[str]([".xxx"])\n\nbackupfilename = String.Format("{0}.zip", DateTime.Now.ToString("yyyyMMdd-HHmmss", CultureInfo.InvariantCulture))\nbackupfiles = List[str]()\n\n####################################################################################################################################### \n# COPY THIS BLOCK IF YOU WANT TO BACKUP MORE THAN 1 PATH ##############################################################################\n#######################################################################################################################################\n# Specify the folder to backup. Sub folders will be included in the backup.\n# All files with the extensions specified in BACKUP_EXTENSIONS will be added to the backup.\n# Set value to ThisService.RootDirectory if you want to backup all specified extensions in the game server\'s root folder and sub folders.\n# This example will backup the path RootDirectory\\garrysmod\\cfg\nFOLDER_TO_BACKUP = Path.Combine(ThisService.RootDirectory, "garrysmod", "cfg")\nbackupdir = DirectoryInfo(FOLDER_TO_BACKUP)\nallfiles = backupdir.GetFiles("*", SearchOption.AllDirectories)\nfor file in allfiles:\n  if not file.FullName.StartsWith(BACKUP_LOCATION) :\n    if Array.IndexOf(BACKUP_EXTENSIONS, file.Extension) != -1 or (Array.IndexOf(BACKUP_EXTENSIONS, ".*") != -1 and Array.IndexOf(BACKUP_EXCLUDE_EXTENSIONS, file.Extension) == -1 ) :\n      backupfiles.Add(file.FullName.Replace(ThisService.RootDirectory, String.Empty).TrimStart(Path.DirectorySeparatorChar))\n####################################################################################################################################### \n#######################################################################################################################################\n   \nif backupfiles.Count == 0 :\n  raise Exception("Didn\\\'t find any files to backup.")\n\nScript.WriteToConsole(String.Format("Backing up {0} files to {1}...", backupfiles.Count, backupfilename))\n \nbackuplocation = DirectoryInfo(BACKUP_LOCATION)\nif not backuplocation.Exists :\n  backuplocation.Create()\n\ncompressiontools = CompressionTools()\ncompressiontools.Compress(ThisService.RootDirectory, backupfiles.ToArray(), Path.Combine(BACKUP_LOCATION, backupfilename))\nScript.WriteToConsole("The backup was created successfully.")\n\nbackupfiles=backuplocation.GetFiles("*.zip").OrderBy(lambda f: f.CreationTime).ToArray()\nfor i in range(0,backupfiles.Count - MAX_BACKUPS):\n  backupfiles[i].Delete()\n  Script.WriteToConsole(String.Format ("Deleted previous backup: {0}", backupfiles[i].Name))\n\nif Environment.OSVersion.Platform == PlatformID.Unix :\n  if Linux.IsRoot() :\n    Linux.SetDirectoryOwnerAutoDetect(BACKUP_LOCATION, True);\nelse :\n owner = Windows.GetOwner(ThisService.RootDirectory);\n Windows.SetDirectoryOwner(BACKUP_LOCATION, str(owner), True);\n'})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Operating System:"})," Any",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Name:"})," Restore Your Settings",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Description:"})," Restore your game server's settings from a backup.",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Script Engine:"})," IronPython",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Event:"})," Custom Icon",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Sub admin access:"})," Checked",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Reseller access:"})," Checked",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"User access:"})," Checked",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Server owner access:"})," Checked",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Stop service before executing:"})," Check if you want to stop the game server before restoring the backup.",(0,i.jsx)(r.br,{}),"\n","Script:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'import clr;\nclr.AddReference("TCAdmin.SDK");\n\nfrom System.IO import Path\nfrom System import String, Environment, PlatformID\nfrom TCAdmin.SDK.Misc import CompressionTools, Linux, Windows\n\nScript.WriteToConsole(String.Format("Restoring backup {0}...", Path.GetFileNameWithoutExtension(ThisService.Variables["BackupFile"])))\n\ncompressiontools = CompressionTools()\ncompressiontools.Decompress(ThisService.Variables["BackupFile"], ThisService.RootDirectory)\n\nif Environment.OSVersion.Platform == PlatformID.Unix :\n  if Linux.IsRoot() :\n    Linux.SetDirectoryOwnerAutoDetect(ThisService.RootDirectory, True);\nelse:\n owner = Windows.GetOwner(ThisService.RootDirectory);\n Windows.SetDirectoryOwner(ThisService.RootDirectory, str(owner), True);\n\nScript.WriteToConsole("The backup was restored successfully.")\n'})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Operating System:"})," Any",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Name:"})," Keep backups before reinstall",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Description:"})," Moves backups outside of root.",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Script Engine:"})," IronPython",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Event:"})," Before reinstall",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Ignore execution errors:"})," Unchecked (if it fails you don't want to lose the backups)\n",(0,i.jsx)(r.strong,{children:"Script:"})," Configure BACKUP_LOCATION"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'import clr;\n\nfrom System import String\nfrom System.IO import Path, Directory\n\n# Specify where backups are saved.\n# Default location is a folder named Backups in the game server\'s root.\nBACKUP_LOCATION = Path.Combine(ThisService.RootDirectory, "Backups")\n\ntemp_location = Path.Combine(ThisService.RootDirectory, "..", String.Format("_{0}_Backups", ThisService.ServiceId))\nif Directory.Exists(BACKUP_LOCATION) :\n  Directory.Move(BACKUP_LOCATION, temp_location)\n'})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Operating System:"})," Any",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Name:"})," Restore backups after install",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Description:"})," Moves backups back into root.",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Script Engine:"})," IronPython",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Event:"})," After reinstall",(0,i.jsx)(r.br,{}),"\n",(0,i.jsx)(r.strong,{children:"Script:"})," Configure BACKUP_LOCATION"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'import clr;\n\nfrom System import String\nfrom System.IO import Path, Directory\n\n# Specify where backups are saved.\n# Default location is a folder named Backups in the game server\'s root.\nBACKUP_LOCATION = Path.Combine(ThisService.RootDirectory, "Backups")\n\ntemp_location = Path.Combine(ThisService.RootDirectory, "..", String.Format("_{0}_Backups", ThisService.ServiceId))\nif Directory.Exists(temp_location) :\n  Directory.Move(temp_location, BACKUP_LOCATION)\n'})})]})}function p(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453(e,r,n){n.d(r,{R:()=>o,x:()=>c});var s=n(96540);const i={},t=s.createContext(i);function o(e){const r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:r},e.children)}}}]);