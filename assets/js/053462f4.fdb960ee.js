"use strict";(self.webpackChunktcadmin_docs=self.webpackChunktcadmin_docs||[]).push([[4285],{4210:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"customizations/scripts/general-scripts/restart-service-if-used-more-than-x-cpu-mem","title":"Restart service if used more than x cpu or memory for the last 3 queries","description":"Create a query monitoring rule","source":"@site/docs/customizations/scripts/general-scripts/restart-service-if-used-more-than-x-cpu-mem.mdx","sourceDirName":"customizations/scripts/general-scripts","slug":"/customizations/scripts/general-scripts/restart-service-if-used-more-than-x-cpu-mem","permalink":"/customizations/scripts/general-scripts/restart-service-if-used-more-than-x-cpu-mem","draft":false,"unlisted":false,"editUrl":"https://github.com/TotalControlAdmin/tcadmin-docs/blob/master/docs/customizations/scripts/general-scripts/restart-service-if-used-more-than-x-cpu-mem.mdx","tags":[],"version":"current","lastUpdatedAt":1737462132000,"sidebarPosition":11,"frontMatter":{"sidebar_position":11,"sidebar_label":"Restart service if used more than x cpu or memory for the last 3 queries"},"sidebar":"tutorialSidebar","previous":{"title":"Open and close ports in Windows firewall","permalink":"/customizations/scripts/general-scripts/open-close-ports-in-windows-firewall"},"next":{"title":"Restart service when last player disconnects","permalink":"/customizations/scripts/general-scripts/restart-service-when-last-player-disconnects"}}');var n=t(4848),i=t(8453);const o={sidebar_position:11,sidebar_label:"Restart service if used more than x cpu or memory for the last 3 queries"},l="Restart service if used more than x cpu or memory for the last 3 queries",a={},c=[{value:"Create a query monitoring rule",id:"create-a-query-monitoring-rule",level:2},{value:"Create the scripts",id:"create-the-scripts",level:2}];function m(e){const r={br:"br",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"restart-service-if-used-more-than-x-cpu-or-memory-for-the-last-3-queries",children:"Restart service if used more than x cpu or memory for the last 3 queries"})}),"\n",(0,n.jsx)(r.h2,{id:"create-a-query-monitoring-rule",children:"Create a query monitoring rule"}),"\n",(0,n.jsx)(r.p,{children:"In the game's query monitoring add this rule and configure it to restart the service:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"HighResources=True\n"})}),"\n",(0,n.jsx)(r.h2,{id:"create-the-scripts",children:"Create the scripts"}),"\n",(0,n.jsx)(r.p,{children:"Go to the game's settings. Click on the Custom Scripts icon. Add the following scripts. Then click on Update Existing Services in the game's settings. These can also be configured as global scripts."}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"Operating System:"})," Any",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Description:"})," Check resource usage.",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Script Engine:"})," IronPython",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Event:"})," Query Monitoring",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Ignore execution errors:"})," Checked",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Script:"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-python",children:'import clr\nimport System\nclr.AddReference("TCAdmin.SDK")\n\nfrom System.Collections.Generic import List\nfrom System.IO import Path, File\nfrom System import String\nfrom TCAdmin.SDK.Misc import ObjectXml\n\n#Script parameters. Change values as needed.\nMaxStoredValues=3\nMaxCPU=50\nMaxMemoryMB=4096\nCPUFile=Path.Combine(ThisService.RootDirectory, "cpu.xml")\nMemoryFile=Path.Combine(ThisService.RootDirectory, "memory.xml")\n\n#Read CPU and memory values stored in files\nif File.Exists(CPUFile) :\n  CPUValues = ObjectXml.XmlToObject(File.ReadAllText(CPUFile), (List[float]()).GetType())\nelse :\n  CPUValues = List[float]()\n\nif File.Exists(MemoryFile) :\n  MemoryValues = ObjectXml.XmlToObject(File.ReadAllText(MemoryFile), (List[float]()).GetType())\nelse :\n  MemoryValues = List[float]()\n \n#Add current CPU and memory values\nCPUValues.Add(ThisService.Status.CpuLastSecond)\nMemoryValues.Add(ThisService.Status.MemoryLastSecond/1024/1024)\n\n#Limit stored values to specified length\nwhile CPUValues.Count > MaxStoredValues :\n  CPUValues.RemoveAt(0)\nwhile MemoryValues.Count > MaxStoredValues :\n  MemoryValues.RemoveAt(0)\n\n#Save values to files\nFile.WriteAllText(CPUFile, ObjectXml.ObjectToXml(CPUValues))\nFile.WriteAllText(MemoryFile, ObjectXml.ObjectToXml(MemoryValues))\n\n#Check if stored values are higher than limits\nAllCPUHigher=True\nif CPUValues.Count == MaxStoredValues :\n  for i in range(0, MaxStoredValues - 1):\n    if CPUValues.Item[i] < MaxCPU :\n      AllCPUHigher=False\nelse :\n  AllCPUHigher=False\n   \nAllMemoryHigher=True\nif MemoryValues.Count == MaxStoredValues :\n  for i in range(0, MaxStoredValues - 1):\n    if MemoryValues.Item[i] < MaxMemoryMB :\n      AllMemoryHigher=False\nelse :\n  AllMemoryHigher=False\n\nif AllCPUHigher | AllMemoryHigher :\n  Script.WriteToConsole(String.Format("High resources detected for {0}", ThisService.ConnectionInfo))\n  QueryResults.Rules.Add("HighResources", "True")\n'})}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"Operating System:"})," Any",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Description:"})," Delete CPU and memory files.",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Script Engine:"})," IronPython",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Event:"})," Before Started",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Ignore execution errors:"})," Checked",(0,n.jsx)(r.br,{}),"\n",(0,n.jsx)(r.strong,{children:"Script:"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-python",children:'import clr\nimport System\nfrom System.IO import Path, File\nCPUFile=Path.Combine(ThisService.RootDirectory, "cpu.xml")\nMemoryFile=Path.Combine(ThisService.RootDirectory, "memory.xml")\n\nif File.Exists(CPUFile) :\n File.Delete(CPUFile)\nif File.Exists(MemoryFile) :\n File.Delete(MemoryFile)\n'})})]})}function u(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(m,{...e})}):m(e)}},8453:(e,r,t)=>{t.d(r,{R:()=>o,x:()=>l});var s=t(6540);const n={},i=s.createContext(n);function o(e){const r=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),s.createElement(i.Provider,{value:r},e.children)}}}]);